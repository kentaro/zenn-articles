---
title: "MirageXã§é–‹ç™ºã—ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’Fly.ioã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹"
emoji: "ğŸ¥"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["MirageX", "flyio", "Resonite"]
published: true
---

:::message
æœ¬è¨˜äº‹ã¯ã€[Resonite Advent Calendar 2023 ãã®3](https://adventar.org/calendars/9735)ã®17æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚
:::

Resoniteä¸Šã§å‹•ããƒªãƒƒãƒãªUIã‚’æŒã¤ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã€Reactã§é–‹ç™ºã§ãã‚‹MirageXã¨ã„ã†ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ãŒç™»å ´ã—ã€èˆˆå¥®ã‚’è¦šãˆã¦ã„ã¾ã™ã€‚é–‹ç™ºè€…ã®[ã‚Œã«ã†ã‚€ã•ã‚“](https://twitter.com/rhenium_nv)ã«ã‚ˆã‚‹ä»¥ä¸‹ã®è¨˜äº‹ã‚’ã”è¦§ãã ã•ã„ã€‚

https://sharedx.notion.site/TypeScript-Resonite-MirageX-5a5dae2e62f9439d9ddf87f6dafd7f51

ã“ã®è¨˜äº‹ã§ã¯ã€MirageXã‚’ä½¿ã£ã¦ä½œæˆã—ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã€Fly.ioã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

:::message alert
è¨˜äº‹åŸ·ç­†ç¾åœ¨ã€MirageXã¯Î±ç‰ˆã§ã™ã€‚ã“ã®å…ˆã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã§çŠ¶æ³ãŒå¤‰ã‚ã‚Šå¾—ã¾ã™ã®ã§ã€æœ€æ–°ã®æƒ…å ±ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
:::

## MirageXã‚’ä½¿ã†ä¸Šã§ã®èª²é¡Œ

MirageXã¯ã¨ã¦ã‚‚ç´ æ™´ã‚‰ã—ã„ä»•çµ„ã¿ã§ã‚ã‚‹ä¸€æ–¹ã§ã€ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã‚µãƒ¼ãƒã‚µã‚¤ãƒ‰ã§å®Ÿè¡Œã™ã‚‹é–¢ä¿‚ã§ã€ä»¥ä¸‹ã®é€šã‚Šã®ãƒ‡ãƒ¡ãƒªãƒƒãƒˆã‚‚ã‚ã‚‹ã¨èª¬æ˜ã•ã‚Œã¦ã„ã¾ã™ã€‚

> ä¸€æ–¹ã§ã€ãƒ‡ãƒ¡ãƒªãƒƒãƒˆã‚‚ã‚ã‚Šã¾ã™ã€‚
>
> - å®Œæˆç‰©ã‚’ç¶­æŒã™ã‚‹ãŸã‚ã«ã‚¤ãƒ³ãƒ•ãƒ©ã‚³ã‚¹ãƒˆãŒã‹ã‹ã‚‹ã€‚

ãã“ã§ã€[Fly.io](https://fly.io/)ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã‚ˆã†ã«ã™ã‚Œã°ã€ç„¡æ–™æ ã®ç¯„å›²å†…ã§ãªã‚‰ã‚¤ãƒ³ãƒ•ãƒ©ã‚³ã‚¹ãƒˆã‚’æŠ‘ãˆã‚‹ã“ã¨ãŒã§ãã‚‹ã®ã§ã¯ãªã„ã‹ã¨è€ƒãˆã¾ã—ãŸã€‚

ã¡ãªã¿ã«ç„¡æ–™æ ã®å†…å®¹ã¯ã€ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

> Resources included for free on all plans:
>
> - Up to 3 shared-cpu-1x 256mb VMs
> - 3GB persistent volume storage (total)
> - 160GB outbound data transfer
>
> Additional resources are billed at the usage-based pricing detailed below.
>
> [Fly.io Resource Pricing Â· Fly Docs](https://fly.io/docs/about/pricing/)

å¸¸ã«ä½¿ã‚ã‚Œã‚‹ã‚ˆã†ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã ã¨ã™ãã«å³ã—ããªã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€ä½¿ã‚ã‚Œã¦ã„ãªã„æ™‚ã¯è‡ªå‹•çš„ã«ã‚µãƒ¼ãƒï¼ˆmachineï¼‰ãŒåœæ­¢ã™ã‚‹è¨­å®šï¼ˆä»¥ä¸‹ã®æ‰‹é †ã§ã¯è‡ªå‹•çš„ã«ãã†ãªã‚Šã¾ã™ï¼‰ã«ã™ã‚Œã°ã€ã¡ã‚‡ã£ã¨ã—ãŸã‚‚ã®ã§ã‚ã‚Œã°ç„¡æ–™æ ã§ã‹ãªã‚Šã®ç¨‹åº¦ã¾ã§ã„ã‘ã‚‹æ°—ã‚‚ã—ã¾ã™ã€‚

## Fly.ioã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹

ã¾ãšã€MirageXã¯[rheniumNV/mirage-x-template](https://github.com/rheniumNV/mirage-x-template)ã§å…¬é–‹ã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã¡ã‚‰ã‚’ä½¿ã£ã¦ã€MirageXã®ã‚µãƒ¼ãƒã‚µã‚¤ãƒ‰ãƒ­ã‚¸ãƒƒã‚¯ã‚’Fly.ioã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã¿ã¾ã™ã€‚

Fly.ioã¸ã®ãƒ¦ãƒ¼ã‚¶ç™»éŒ²ã‚„`fly`ã‚³ãƒãƒ³ãƒ‰ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€ã¯æ¸ˆã‚“ã§ã„ã‚‹ã‚‚ã®ã¨ã—ã¾ã™ã€‚åˆã‚ã¦ã®æ–¹ã¯ã€[Install flyctl Â· Fly Docs](https://fly.io/docs/hands-on/install-flyctl/)ã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚

### Fly.ioã®åˆæœŸè¨­å®šã‚’ã™ã‚‹

MirageXã‚’`git clone`ã—ãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•ã—ã€`fly launch`ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚Fly.ioä¸Šã§ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã€ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä¸Šã§ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆãŒè¡Œã‚ã‚Œã¾ã™ã€‚

```bash
$ fly launch
Scanning source code
Detected a NodeJS app
Creating app in /home/kentaro/src/github.com/rheniumNV/mirage-x-template
We're about to launch your NodeJS app on Fly.io. Here's what you're getting:

Organization: Kentaro Kuribayashi    (fly launch defaults to the personal org)
Name:         mirage-x-template      (derived from your directory name)
Region:       Tokyo, Japan           (this is the fastest region for you)
App Machines: shared-cpu-1x, 1GB RAM (most apps need about 1GB of RAM)
Postgres:     <none>                 (not requested)
Redis:        <none>                 (not requested)

? Do you want to tweak these settings before proceeding? (y/N)
```

ã‚¢ãƒ—ãƒªã®åå‰ã ã‘å¤‰æ›´ã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚æœ€å¾Œã®è³ªå•ã«`y`ã¨ç­”ãˆã¾ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ãŒé–‹ã„ã¦è¨­å®šç”»é¢ãŒå‡ºã¦ãã‚‹ã®ã§ã€åå‰ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã—ãŸï¼ˆãŠå¥½ã¿ã®åå‰ã«å¤‰ãˆã¦ãã ã•ã„ï¼‰ã€‚

![](https://storage.googleapis.com/zenn-user-upload/f777dcad1085-20231217.png)

`git status`ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®é€šã‚Šãƒ•ã‚¡ã‚¤ãƒ«ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

```bash
$ git status
On branch master
Your branch is up to date with 'origin/master'.

Changes not staged for commit:
  (use "git add <file>..." to update what will be committed)
  (use "git restore <file>..." to discard changes in working directory)
        modified:   package-lock.json
        modified:   package.json

Untracked files:
  (use "git add <file>..." to include in what will be committed)
        .dockerignore
        Dockerfile
        fly.toml

no changes added to commit (use "git add" and/or "git commit -a")
```

`package.json`ã¸ã®å¤‰æ›´ã¯ã€`@flydotio/dockerfile`ã®è¿½åŠ ã«ã‚ˆã‚‹ã‚‚ã®ã§ã™ã€‚

```diff
$ git diff package.json
diff --git a/package.json b/package.json
index 2a410e5..5c0628b 100644
--- a/package.json
+++ b/package.json
@@ -22,6 +22,7 @@
     "prepare": "husky install"
   },
   "devDependencies": {
+    "@flydotio/dockerfile": "^0.4.11",
     "@types/cors": "^2.8.14",
     "@types/express": "^4.17.17",
     "@types/jest": "^29.5.3",
```

### ãƒ‡ãƒ—ãƒ­ã‚¤ã«é–¢ã™ã‚‹è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã™ã‚‹

å‰è¿°ã®é€šã‚Š`.dockerignore`, `Dockerfile`, `fly.toml`ã¨ã„ã†3ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã¾ã™ã€‚ã“ã“ã§ã¯ã€`.dockerignore`, `Dockerfile`ã‚’ç·¨é›†ã—ã¾ã™ã€‚

#### `.dockerignore`ã‚’ç·¨é›†ã™ã‚‹

`.dockerignore`ã§ã¯ã€`.env`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é™¤å¤–ã™ã‚‹è¨­å®šã«ãªã£ã¦ã„ã¾ã™ãŒã€ãƒ“ãƒ«ãƒ‰æ™‚ã«`.env`ã«æ›¸ãè¾¼ã‚“ã§ã„ã‚‹ç’°å¢ƒå¤‰æ•°ãŒãªã„ã¨é©åˆ‡ãªæˆæœç‰©ã‚’å¾—ã‚‰ã‚Œãªã„ã®ã§ã€`.env`ã‚’é™¤å¤–ã—ãªã„ã‚ˆã†ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã—ã¾ã™ã€‚

```conf
# .env
```

`fly secrets`ã§è¨­å®šã™ã‚‹å¤‰æ•°ã¯ã€ã‚µãƒ¼ãƒã®å®Ÿè¡Œæ™‚ã«ãŠã„ã¦å‚ç…§ã§ãã‚‹ã‚‚ã®ãªã®ã§ã€ãƒ“ãƒ«ãƒ‰æ™‚ã«ã¯åˆ¥ã®å½¢ã§æ¸¡ã—ã¦ã‚„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ä»¥ä¸‹ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚ã‚Œã“ã‚Œæ›¸ã‹ã‚Œã¦ã„ã¾ã™ã€‚

> You can set secrets for your applications, but these are only available at run-time. They arenâ€™t available when building your Docker image without a little extra work.
>
> [Build Secrets Â· Fly Docs](https://fly.io/docs/reference/build-secrets/)

ãŸã ã€ã“ã“ã§ã¯ç‰¹ã«ç§˜åŒ¿æƒ…å ±ã‚’æ‰±ã£ã¦ã„ã‚‹ã‚ã‘ã§ã¯ãªã„ã®ã§ã€ã“ã®æ–¹æ³•ã§è¡Œãã“ã¨ã«ã—ã¾ã—ãŸã€‚ã‚‚ã¡ã‚ã‚“ã€ãƒªãƒã‚¸ãƒˆãƒªã«ã‚³ãƒŸãƒƒãƒˆã—ã¦ã¯ã„ã‘ã¾ã›ã‚“ï¼ˆ`.gitignore`ã§ã¯é™¤å¤–è¨­å®šãŒã•ã‚Œã¦ã„ã¾ã™ï¼‰ã€‚

#### `Dockerfile`ã‚’ç·¨é›†ã™ã‚‹

ã“ã‚Œã‚‚ç’°å¢ƒå¤‰æ•°ã«é–¢ã™ã‚‹ã“ã¨ã§ã™ã€‚`Dockerfile`å†…ã‚’ã€ä»¥ä¸‹ã®é€šã‚Šã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã—ã¾ã™ã€‚

```conf
# Remove development dependencies
# RUN npm prune --omit=dev
```

ã“ã‚Œã§ã‚µãƒ¼ãƒã®èµ·å‹•ã™ã‚‹ã‚¯ãƒªãƒ—ãƒˆ`npm run start`ã¨ã—ã¦è¨­å®šã•ã‚Œã¦ã„ã‚‹ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ãŒé©åˆ‡ã«å®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```js
"start": "node --require dotenv/config ./dist/server/index.js",
```

ã“ã®è¾ºã¯æœ¬æ¥ã¯`fly secrets`ã§è¨­å®šã—ãŸç’°å¢ƒå¤‰æ•°ã‚’ä½¿ã†ã®ãŒã„ã„ã®ã§ã™ãŒã€ç›´å‰ã®`.dockerignore`ã®ç·¨é›†ã§`.env`ãŒãƒ“ãƒ«ãƒ‰æ™‚ã«å‚ç…§ã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã®ã§ã€ã“ã“ã§ã¯`.env`ã«æ›¸ã‹ã‚ŒãŸç’°å¢ƒå¤‰æ•°ã‚’ä½¿ã†ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

### ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã™ã‚‹

`fly status`ã‚’å®Ÿè¡Œã—ã¦ã€ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ç¢ºèªã—ã¾ã™ã€‚ã“ã“ã§ã¯`mirage-x-flyio.fly.dev`ã¨ã„ã†ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒã‚ã¦ã‚‰ã‚Œã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

```bash
$ fly status
App
  Name     = mirage-x-flyio
  Owner    = personal
  Hostname = mirage-x-flyio.fly.dev
  Image    = -
  Platform = machines
```

`.env.sample`ã‚’`.env`ã«ã‚³ãƒ”ãƒ¼ã—ã¦ã€`MIRAGE_URL`ã®ç®‡æ‰€ã‚’ä¸Šè¨˜ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ç”¨ã„ãŸURLã«å¤‰æ›´ã—ã¾ã™ï¼ˆhttpsã«ã™ã‚‹ã®ã‚’ãŠå¿˜ã‚Œãªãï¼‰ã€‚

```diff
MIRAGE_URL="https://mirage-x-flyio.fly.dev/"
```

## Fly.ioã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹

ã“ã“ã¾ã§ããŸã‚‰ã€ã‚ã¨ã¯ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã ã‘ã§ã™ã€‚`fly deploy`ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```bash
$ fly deploy

(...)

Visit your newly deployed app at https://mirage-x-flyio.fly.dev/
```

ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ãŸã‚‰ã€è¡¨ç¤ºã•ã‚ŒãŸURLã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¤ãªãŒã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºã‹ã‚ã¦ã¿ã¾ã—ã‚‡ã†ï¼ˆä¸Šè¨˜ã®URLã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€è¨˜äº‹åŸ·ç­†æ™‚ç¾åœ¨ã ã¨`NotFound`ã¨è¡¨ç¤ºã•ã‚Œã¾ã™ãŒã€ãã‚Œã§OKã§ã™ï¼‰ã€‚

## ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚¢ãƒ—ãƒªã‚’Resoniteä¸Šã§å‹•ã‹ã™

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚¢ãƒ—ãƒªã¯ã€ã‚µãƒ¼ãƒä¸Šã§ãƒ“ãƒ«ãƒ‰æ™‚ã«ç”Ÿæˆã•ã‚Œã¦ã„ã¾ã™ã€‚ã‚µãƒ¼ãƒä¸Šã®`/output.brson`ã‹ã‚‰å–å¾—ã§ãã¾ã™ã€‚ä»Šå›ã®ä¾‹ã ã¨ https://mirage-x-flyio.fly.dev/output.brson ã§ã™ã€‚

`output.brson`ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ€ã‚¦ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹ã®ã§ã€ãã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ãƒ¼ãƒ©ãƒ¼ã‹ã‚‰Resoniteã«ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¾ã™ã€‚ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚¢ãƒ©ãƒ¼ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/b5ba07a83201-20231217.png)

é€šä¿¡ã‚’è¨±å¯ã™ã‚‹ã¨ã€ã‚µãƒ³ãƒ—ãƒ«ã¨ã—ã¦ç”¨æ„ã•ã‚Œã¦ã„ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/e6a649a6bbfa-20231217.png)

## ãŠã‚ã‚Šã«

MirageXã§ä½œæˆã—ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç¶­æŒã™ã‚‹ã®ã«ã‚³ã‚¹ãƒˆãŒã‹ã‹ã‚‹å•é¡Œã«ã¤ã„ã¦ã€Fly.ioã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã“ã¨ã§ã€ä¸€å®šç¨‹åº¦è§£æ±ºã—å¾—ã‚‹ã“ã¨ã‚’ç¤ºã—ã¾ã—ãŸã€‚MirageXã¯æŠ€è¡“çš„ã«ã‚‚ã‚ã¡ã‚ƒãã¡ã‚ƒé¢ç™½ã„ã®ã§ã€ä»Šåº¦ã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã¤ãã£ã¦ã¿ãŸã„ã¨ãŠã‚‚ã„ã¾ã™ã€‚
